<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulário de Pedido - PSR Etiquetas</title>
  <style>
    /* TODO: mantenha todo o seu CSS existente aqui, sem alterações */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://i.postimg.cc/8CR5BZVj/200x70.png" alt="Logo PSR Indústria" width="150" height="52.5">
      <h1>Emissão de Pedido - PSR Indústria</h1>
    </div>
    <div class="form-content">
      <form id="pedidoForm" class="rd-form" data-rdstation-form="552fc004-6b96-4465-944a-c4f5c4132f83">
        <!-- Representante Comercial -->
        <div class="section">
          <div class="form-group">
            <label for="representante">Representante Comercial:</label>
            <input type="text" id="representante" name="cf_vendedor" placeholder="Nome do representante">
          </div>
        </div>
        <!-- Informações do Cliente -->
        <div class="section">
          <h2 class="section-title">Informações do Cliente</h2>
          <div class="form-group">
            <div class="form-row">
              <div>
                <label for="cliente">Cliente:</label>
                <input type="text" id="cliente" name="company_name" placeholder="Nome do cliente/empresa">
              </div>
              <div>
                <label for="pedidoCompra">Nº Pedido de Compra Cliente:</label>
                <input type="text" id="pedidoCompra" name="pedidoCompra" placeholder="Número do pedido">
              </div>
            </div>
          </div>
          <div class="form-group">
            <div class="form-row-3">
              <div>
                <label for="telefone">Telefone:</label>
                <input type="tel" id="telefone" name="cf_contato" placeholder="(00) 00000-0000">
              </div>
              <div>
                <label for="cnpj">CNPJ:</label>
                <input type="text" id="cnpj" name="cf_cnpj" placeholder="00.000.000/0000-00" maxlength="18">
              </div>
              <div>
                <label for="email">E-mail Comprador/Financeiro:</label>
                <input type="email" id="email" name="email" placeholder="email@empresa.com">
              </div>
            </div>
          </div>
        </div>
        <!-- Itens do Pedido, Resumo, Entrega, Observações e Botões permanecem iguais -->
        <div style="text-align: center; margin-bottom: 20px;">
          <button type="submit" class="btn" style="font-size: 18px; padding: 15px 40px;">
            Finalizar Pedido
          </button>
        </div>
        <div style="text-align: center;">
          <button type="button" class="btn btn-orange" onclick="confirmClearForm()" style="font-size: 14px; padding: 10px 25px;">
            Limpar Formulário
          </button>
        </div>
      </form>
    </div>
  </div>

    <!-- Modal para Resumo de Item -->
    <div id="itemSummaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Resumo do Item</h3>
                <button type="button" class="close-btn" onclick="closeItemSummaryModal()">&times;</button>
            </div>
            <div id="itemSummaryContent"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeItemSummaryModal()">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        let items = [];

        // Evita envios múltiplos
        document.getElementById('pedidoForm').addEventListener('submit', function(e) {
            var btn = this.querySelector('[type="submit"]');
            if (btn) btn.disabled = true;
            setTimeout(() => { if (btn) btn.disabled = false; }, 5000);
        });

        // Máscara CNPJ
        document.getElementById('cnpj').addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g,'').slice(0,14);
            if (v.length > 12) v = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2}).*/, "$1.$2.$3/$4-$5");
            else if (v.length > 8) v = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{0,4}).*/, "$1.$2.$3/$4");
            else if (v.length > 5) v = v.replace(/^(\d{2})(\d{3})(\d{0,3}).*/, "$1.$2.$3");
            else if (v.length > 2) v = v.replace(/^(\d{2})(\d{0,3}).*/, "$1.$2");
            e.target.value = v;
        });

        // Exibe/Oculta 'Detalhes' conforme Impressão
        document.getElementById('itemImpressao').addEventListener('change', function() {
            const detalhesGroup = document.getElementById('itemDetalhesGroup');
            detalhesGroup.style.display = (this.value === 'Pers.') ? 'block' : 'none';
        });

        function openItemModal() {
            document.getElementById('itemModal').style.display = 'block';
        }
        function closeItemModal() {
            document.getElementById('itemModal').style.display = 'none';
            document.getElementById('itemQtd').value = '';
            document.getElementById('itemUnidade').value = 'rolos';
            document.getElementById('itemProduto').value = '';
            document.getElementById('itemMedidaAdesivo').value = '';
            document.getElementById('itemImpressao').value = 'Lisa';
            document.getElementById('itemMetroRolo').value = '';
            document.getElementById('itemDetalhes').value = '';
            document.getElementById('itemDetalhesGroup').style.display = 'none';
            document.getElementById('itemValorUnitario').value = '';
        }

        function addItem() {
            const quantidade = parseFloat(document.getElementById('itemQtd').value);
            const unidade = document.getElementById('itemUnidade').value;
            const produto = document.getElementById('itemProduto').value;
            const medidaAdesivo = document.getElementById('itemMedidaAdesivo').value;
            const impressao = document.getElementById('itemImpressao').value;
            const detalhes = document.getElementById('itemDetalhes').value;
            const metroRolo = document.getElementById('itemMetroRolo').value;
            const valorUnitario = parseFloat(document.getElementById('itemValorUnitario').value);

            if (!quantidade || !produto || !valorUnitario) {
                alert('Por favor, preencha pelo menos a quantidade, produto e valor unitário.');
                return;
            }
            items.push({ quantidade, unidade, produto, medidaAdesivo, impressao, detalhes, metroRolo, valorUnitario });
            updateItemsTable();
            closeItemModal();
        }

        function removeItem(index) {
            if (confirm('Tem certeza que deseja remover este item?')) {
                items.splice(index, 1);
                updateItemsTable();
            }
        }

        function openItemSummaryModal(item) {
            const modal = document.getElementById('itemSummaryModal');
            const content = document.getElementById('itemSummaryContent');
            content.innerHTML = `
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">
                    <p><strong>Quantidade:</strong> ${item.quantidade} ${item.unidade}</p>
                    <p><strong>Produto:</strong> ${item.produto}</p>
                    <p><strong>Medida do Adesivo:</strong> ${item.medidaAdesivo}</p>
                    <p><strong>Impressão:</strong> ${item.impressao}</p>
                    ${item.detalhes ? `<p><strong>Detalhes:</strong> ${item.detalhes}</p>` : ''}
                    <p><strong>Metro do Rolo:</strong> ${item.metroRolo}</p>
                    <p style="font-weight:bold; color:#003366;"><strong>Valor Unitário:</strong> R$ ${item.valorUnitario.toFixed(2).replace('.', ',')}</p>
                </div>
            `;
            modal.style.display = 'block';
        }
        function closeItemSummaryModal() {
            document.getElementById('itemSummaryModal').style.display = 'none';
        }

        function updateItemsTable() {
            const tableBody = document.getElementById('itemsTableBody');
            tableBody.innerHTML = '';
            if (items.length === 0) {
                tableBody.innerHTML = `
                    <tr class="empty-state">
                        <td colspan="7">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM10 6a2 2 0 0 1 4 0v1h-4V6zm8 13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V9h2v1a1 1 0 0 0 2 0V9h2v10z"/></svg>
                            <p>Nenhum item adicionado</p>
                            <small>Clique em "Adicionar Item" para começar</small>
                        </td>
                    </tr>
                `;
            } else {
                items.forEach((item, index) => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.quantidade} ${item.unidade}</td>
                        <td>${item.produto}</td>
                        <td>${item.medidaAdesivo}</td>
                        <td>${item.impressao}</td>
                        <td>${item.metroRolo}</td>
                        <td>R$ ${item.valorUnitario.toFixed(2).replace('.', ',')}</td>
                        <td><button type="button" class="remove-item" onclick="removeItem(${index})">&times;</button></td>
                    `;
                    row.addEventListener('click', e => {
                        if (!e.target.classList.contains('remove-item')) openItemSummaryModal(item);
                    });
                });
            }
            updateTotal();
        }

        function updateTotal() {
            const summaryElement = document.getElementById('orderSummary');
            if (items.length === 0) {
                summaryElement.innerHTML = '<p>Nenhum item adicionado</p>';
                return;
            }
            let cxBobinas = 0, cxEtiquetas = 0, cxRotulos = 0, cxRibbons = 0;
            let summaryHTML = '<div style="font-size:14px; line-height:1.6;">';

            items.forEach(item => {
                if (item.unidade === 'rolos' || item.unidade === 'milheiro') {
                    const p = item.produto.toLowerCase();
                    if (p.includes('bob.')) cxBobinas += item.quantidade;
                    else if (p.includes('etq')) cxEtiquetas += item.quantidade;
                    else if (p.includes('rótulo') || p.includes('rotulo')) cxRotulos += item.quantidade;
                    else if (p.includes('ribbon')) cxRibbons += item.quantidade;
                }
            });

            summaryHTML += `
                <div style="margin-top:15px; padding:12px; background:rgba(255,255,255,0.2); border-radius:4px; border:1px solid rgba(255,255,255,0.3);">
                    <strong style="font-size:18px;">Qtd total:</strong><br>
                    <span style="font-size:16px;">
                        Qtd de Bobinas: ${cxBobinas} |
                        Qtd de Etiquetas: ${cxEtiquetas} |
                        Qtd de Rótulos: ${cxRotulos} |
                        Qtd de Ribbons: ${cxRibbons}
                    </span>
                </div>
            `;
            summaryHTML += '</div>';
            summaryElement.innerHTML = summaryHTML;
        }

        function confirmClearForm() {
            if (confirm('Tem certeza que deseja limpar todo o formulário? Esta ação não pode ser desfeita.')) {
                document.getElementById('pedidoForm').reset();
                items = [];
                updateItemsTable();
                document.getElementById('dataEmissao').value = new Date().toISOString().split('T')[0];
            }
        }

        window.onclick = function(event) {
            if (event.target === document.getElementById('itemModal')) closeItemModal();
            if (event.target === document.getElementById('itemSummaryModal')) closeItemSummaryModal();
        };

        document.addEventListener('DOMContentLoaded', () => {
            updateItemsTable();
            document.getElementById('dataEmissao').value = new Date().toISOString().split('T')[0];
        });
    </script>

  <!-- RD Station Loader -->
  <script async src="https://d335luupugsy2.cloudfront.net/js/loader-scripts/552fc004-6b96-4465-944a-c4f5c4132f83-loader.js"></script>

  <!-- ==== Lógica CRM v1 com vinculação por CNPJ ==== -->
  <script>
    const ACCESS_TOKEN = '65c66ab166c32000165ab7b8';  // seu token de acesso

    // 1. Buscar Empresa pelo CNPJ (campo customizado ID: 68652b3ca12866001866c0b4)
    async function getOrganizationIdByCNPJ(cnpj) {
      let page = 1;
      while (true) {
        const resp = await fetch(`https://crm.rdstation.com/api/v1/organizations?page=${page}&per_page=50`, {
          headers: {
            'Authorization': `Bearer ${ACCESS_TOKEN}`,
            'Accept': 'application/json'
          }
        });
        const data = await resp.json();
        const orgs = data.organizations || [];
        if (orgs.length === 0) break;
        const found = orgs.find(o =>
          o.custom_fields &&
          o.custom_fields['68652b3ca12866001866c0b4'] === cnpj
        );
        if (found) return found.id;
        if (orgs.length < 50) break;
        page++;
      }
      return null;
    }

    // 2. Criar Empresa se não existir
    async function createOrganization(name, cnpj) {
      const resp = await fetch('https://crm.rdstation.com/api/v1/organizations', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${ACCESS_TOKEN}`,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          name,
          custom_fields: {
            '68652b3ca12866001866c0b4': cnpj
          }
        })
      });
      return await resp.json();
    }

    // 3. Criar Contato vinculado à Empresa (campo customizado CNPJ do contato ID: 65e5fb49eaf2aa0019569415)
    async function createContact(name, email, phone, orgId, cnpj) {
      const resp = await fetch('https://crm.rdstation.com/api/v1/contacts', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${ACCESS_TOKEN}`,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          name,
          email: [{ label: 'work', value: email }],
          phones: [{ label: 'work', value: phone }],
          organization_id: orgId,
          custom_fields: {
            '65e5fb49eaf2aa0019569415': cnpj
          },
          legal_bases: [{ selection: 'consent', type: 'express' }]
        })
      });
      return await resp.json();
    }

    // 4. Interceptar submissão do formulário
    document.getElementById('pedidoForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const btn = this.querySelector('[type="submit"]');
      if (btn) btn.disabled = true;

      try {
        const nome     = document.getElementById('cliente').value.trim();
        const email    = document.getElementById('email').value.trim();
        const telefone = document.getElementById('telefone').value.trim();
        const cnpj     = document.getElementById('cnpj').value.trim();

        // Buscar ou criar Empresa
        let orgId = await getOrganizationIdByCNPJ(cnpj);
        if (!orgId) {
          const newOrg = await createOrganization(nome, cnpj);
          orgId = newOrg.id;
        }

        // Criar Contato vinculado
        const contact = await createContact(nome, email, telefone, orgId, cnpj);
        alert('Contato criado com sucesso! ID: ' + contact.id);

        this.reset();
      } catch (err) {
        console.error(err);
        alert('Erro ao criar contato: ' + (err.message || err));
      } finally {
        if (btn) btn.disabled = false;
      }
    });
  </script>
</body>
</html>
