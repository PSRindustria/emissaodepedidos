<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulário de Pedido - PSR Etiquetas</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: #003366;
      padding: 30px 30px 15px;
      color: white;
      text-align: center;
    }
    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
      font-weight: 600;
      padding-top: 15px;
    }
    .form-content { padding: 40px; }
    .section { margin-bottom: 40px; }
    .section-title {
      font-size: 20px; font-weight: 600; color: #2d3748;
      margin-bottom: 20px; display: flex; align-items: center; gap: 10px;
    }
    .section-title::before {
      content: ''; width: 4px; height: 20px; background: #003366; border-radius: 2px;
    }
    .form-group { margin-bottom: 20px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    label {
      display: block; margin-bottom: 8px; font-weight: 500;
      color: #4a5568; font-size: 14px;
    }
    input, select, textarea {
      width: 100%; padding: 12px 16px;
      border: 2px solid #e2e8f0; border-radius: 8px;
      font-size: 16px; transition: all 0.3s ease; background: white;
    }
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: #003366;
      box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
      transform: translateY(-1px);
    }
    .items-section {
      background: #f8fafc; border-radius: 12px; padding: 25px; margin-bottom: 30px;
    }
    .items-table {
      width: 100%; border-collapse: collapse; margin-bottom: 20px;
      background: white; border-radius: 8px; overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .items-table th {
      background: #003366; color: white;
      padding: 15px 10px; text-align: left; font-weight: 500; font-size: 14px;
    }
    .items-table td {
      padding: 15px 10px; border-bottom: 1px solid #e2e8f0; color: #4a5568;
    }
    .items-table tbody tr:hover { background: #f8fafc; }
    .empty-state { text-align: center; padding: 40px 20px; color: #718096; }
    .btn {
      background: #003366; color: white; border: none;
      padding: 12px 24px; border-radius: 8px; cursor: pointer;
      font-size: 16px; font-weight: 500; transition: all 0.3s ease;
      display: inline-flex; align-items: center; gap: 8px;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 51, 102, 0.3);
      background: #002244;
    }
    .btn-secondary {
      background: #e2e8f0; color: #4a5568;
    }
    .btn-secondary:hover {
      background: #cbd5e0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .btn-orange {
      background: linear-gradient(135deg, #ff8c00 0%, #ff6600 100%); color: white;
    }
    .btn-orange:hover {
      background: linear-gradient(135deg, #ff7700 0%, #ff5500 100%);
      box-shadow: 0 8px 25px rgba(255, 140, 0, 0.3);
    }
    .modal {
      display: none; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%; background: rgba(0,0,0,0.7);
      z-index: 1000; backdrop-filter: blur(4px);
    }
    .modal-content {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white; border-radius: 16px; padding: 30px;
      width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;
      animation: modalSlideIn 0.3s ease;
    }
    @keyframes modalSlideIn {
      from { opacity: 0; transform: translate(-50%, -60%); }
      to   { opacity: 1; transform: translate(-50%, -50%); }
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;
    }
    .close-btn {
      background: none; border: none; font-size: 24px;
      cursor: pointer; color: #718096; padding: 0;
    }
    .close-btn:hover { color: #2d3748; }
    .modal-actions {
      display: flex; gap: 12px; justify-content: flex-end;
      margin-top: 25px; padding-top: 20px; border-top: 1px solid #e2e8f0;
    }
    .total-section {
      background: #003366; color: white; padding: 25px;
      border-radius: 12px; text-align: right; margin-bottom: 30px;
    }
    .total-section h3 { font-size: 24px; margin-bottom: 8px; }
    .remove-item {
      background: none; border: none; color: #e53e3e;
      cursor: pointer; padding: 4px; border-radius: 4px;
      transition: background 0.2s;
    }
    .remove-item:hover { background: #fed7d7; }
    @media (max-width: 768px) {
      body { padding: 10px; }
      .form-content { padding: 20px; }
      .header { padding: 20px; }
      .header h1 { font-size: 24px; }
      .form-row, .form-row-3 { grid-template-columns: 1fr; }
      .items-table th, .items-table td { padding: 10px 6px; }
      .modal-content { width: 95%; padding: 20px; }
    }
    @media (max-width: 480px) {
      .items-table th:nth-child(n+4),
      .items-table td:nth-child(n+4) { display: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Emissão de Pedido - PSR Indústria</h1>
    </div>
    <div class="form-content">
      <form id="pedidoForm" class="rd-form" data-rdstation-form="552fc004-6b96-4465-944a-c4f5c4132f83">
        <!-- Representante Comercial -->
        <div class="section">
          <div class="form-group">
            <label for="representante">Representante Comercial:</label>
            <input type="text" id="representante" name="cf_vendedor" placeholder="Nome do representante">
          </div>
        </div>
        <!-- Informações do Cliente -->
        <div class="section">
          <h2 class="section-title">Informações do Cliente</h2>
          <div class="form-group">
            <div class="form-row">
              <div>
                <label for="cliente">Cliente:</label>
                <input type="text" id="cliente" name="company_name" placeholder="Nome do cliente/empresa">
              </div>
              <div>
                <label for="pedidoCompra">Nº Pedido de Compra Cliente:</label>
                <input type="text" id="pedidoCompra" name="pedidoCompra" placeholder="Número do pedido">
              </div>
            </div>
          </div>
          <div class="form-group">
            <div class="form-row-3">
              <div>
                <label for="telefone">Telefone:</label>
                <input type="tel" id="telefone" name="cf_contato" placeholder="(00) 00000-0000">
              </div>
              <div>
                <label for="cnpj">CNPJ:</label>
                <input type="text" id="cnpj" name="cf_cnpj" placeholder="00.000.000/0000-00" maxlength="18">
                <!-- envia ao campo Empresa no CRM -->
                <input type="hidden"
                       id="crm_cnpj_empresa"
                       name="custom_fields[65e5fb49eaf2aa0019569415]"
                       value="">
              </div>
              <div>
                <label for="email">E-mail Comprador/Financeiro:</label>
                <input type="email" id="email" name="email" placeholder="email@empresa.com">
              </div>
            </div>
          </div>
        </div>
        <!-- Itens do Pedido -->
        <div class="section">
          <h2 class="section-title">Itens do Pedido</h2>
          <div class="items-section">
            <table class="items-table" id="itemsTable">
              <thead>
                <tr>
                  <th>Qtd.</th><th>Produto</th><th>Medida</th>
                  <th>Impressão</th><th>M</th><th>R$ Unit.</th><th>Ações</th>
                </tr>
              </thead>
              <tbody id="itemsTableBody">
                <tr class="empty-state">
                  <td colspan="7">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                      <path d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM10 6a2 2 0 0 1 4 0v1h-4V6zm8 13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V9h2v1a1 1 0 0 0 2 0V9h2v10z"/>
                    </svg>
                    <p>Nenhum item adicionado</p>
                    <small>Clique em "Adicionar Item" para começar</small>
                  </td>
                </tr>
              </tbody>
            </table>
            <button type="button" class="btn" onclick="openItemModal()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
              </svg>
              Adicionar Item
            </button>
          </div>
        </div>
        <!-- Resumo do Pedido -->
        <div class="total-section">
          <h3>Resumo do Pedido</h3>
          <div id="orderSummary" style="text-align: left;">
            <p>Nenhum item adicionado</p>
          </div>
        </div>
        <!-- Entrega e Pagamento -->
        <div class="section">
          <h2 class="section-title">Informações de Entrega e Pagamento</h2>
          <div class="form-group">
            <div class="form-row">
              <div>
                <label for="dataEmissao">Data de Emissão:</label>
                <input type="date" id="dataEmissao" name="dataEmissao" readonly style="background: #f8fafc;">
              </div>
              <div>
                <label for="condicoesPagamento">Condições de Pagamento:</label>
                <input type="text" id="condicoesPagamento" name="condicoesPagamento" placeholder="Ex: 28 dias">
              </div>
            </div>
          </div>
        </div>
        <!-- Observações -->
        <div class="section">
          <h2 class="section-title">Observações</h2>
          <div class="form-group">
            <textarea id="observacoes" name="observacoes" rows="4" placeholder="Observações adicionais..."></textarea>
          </div>
        </div>
        <!-- Ações -->
        <div style="text-align: center; margin-top: 40px;">
          <button type="submit" class="btn" style="font-size:18px; padding:15px 40px;">Finalizar Pedido</button>
          <button type="button" class="btn btn-orange" onclick="confirmClearForm()" style="font-size:14px; padding:10px 25px; margin-top:10px;">
            Limpar Formulário
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Adicionar Item -->
  <div id="itemModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Adicionar Item ao Pedido</h3>
        <button class="close-btn" onclick="closeItemModal()">&times;</button>
      </div>
      <div class="form-group">
        <div class="form-row">
          <div>
            <label for="itemQtd">Quantidade:</label>
            <input type="number" id="itemQtd" min="1" placeholder="Ex: 30">
          </div>
          <div>
            <label for="itemUnidade">Unidade:</label>
            <select id="itemUnidade">
              <option value="CXS">CXS</option>
            </select>
          </div>
        </div>
      </div>
      <div class="form-group">
        <div class="form-row">
          <div>
            <label for="itemProduto">Produto:</label>
            <select id="itemProduto">
              <option value="">Selecione o produto</option>
              <option value="Bob. PDV">Bobina PDV</option>
              <!-- … demais opções … -->
            </select>
          </div>
          <div>
            <label for="itemMedidaAdesivo">Medida do Adesivo:</label>
            <input type="text" id="itemMedidaAdesivo" placeholder="Ex: 60x150">
          </div>
        </div>
      </div>
      <div class="form-group">
        <div class="form-row">
          <div>
            <label for="itemImpressao">Impressão:</label>
            <select id="itemImpressao">
              <option value="Lisa">Lisa</option>
              <option value="Pers.">Personalizada</option>
            </select>
          </div>
        </div>
      </div>
      <!-- novo campo Detalhes, escondido por padrão -->
      <div class="form-group" id="detalhesGroup" style="display: none;">
        <label for="itemDetalhes">Detalhes:</label>
        <input type="text" id="itemDetalhes" placeholder="Descreva a personalização">
      </div>
      <div class="form-group">
        <label for="itemValorUnitario">Valor Unitário do Rolo (R$):</label>
        <input type="number" id="itemValorUnitario" step="0.01" min="0" placeholder="R$ 0,00">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeItemModal()">Cancelar</button>
        <button class="btn" onclick="addItem()">Adicionar Item</button>
      </div>
    </div>
  </div>

  <!-- Modal: Resumo do Item -->
  <div id="itemSummaryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Resumo do Item</h3>
        <button class="close-btn" onclick="closeItemSummaryModal()">&times;</button>
      </div>
      <div id="itemSummaryContent"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeItemSummaryModal()">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    let items = [];

    // bloqueio múltiplo envio
    document.getElementById('pedidoForm').addEventListener('submit', function(e) {
      const btn = this.querySelector('[type="submit"]');
      if (btn) btn.disabled = true;
      setTimeout(() => btn.disabled = false, 5000);
    });

    // máscara CNPJ + sync CRM
    document.getElementById('cnpj').addEventListener('input', function(e) {
      let v = e.target.value.replace(/\D/g,'').slice(0,14);
      if (v.length > 12) v = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2}).*/, "$1.$2.$3/$4-$5");
      else if (v.length > 8) v = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{0,4}).*/, "$1.$2.$3/$4");
      else if (v.length > 5) v = v.replace(/^(\d{2})(\d{3})(\d{0,3}).*/, "$1.$2.$3");
      else if (v.length > 2) v = v.replace(/^(\d{2})(\d{0,3}).*/, "$1.$2");
      e.target.value = v;
      document.getElementById('crm_cnpj_empresa').value = v;
    });

    // abre modal e reseta detalhes
    function openItemModal() {
      document.getElementById('itemDetalhes').value = '';
      document.getElementById('detalhesGroup').style.display = 'none';
      document.getElementById('itemModal').style.display = 'block';
    }
    function closeItemModal() {
      document.getElementById('itemModal').style.display = 'none';
      document.getElementById('itemDetalhes').value = '';
      document.getElementById('detalhesGroup').style.display = 'none';
      // limpa demais campos…
      document.getElementById('itemQtd').value = '';
      document.getElementById('itemUnidade').value = 'CXS';
      document.getElementById('itemProduto').value = '';
      document.getElementById('itemMedidaAdesivo').value = '';
      document.getElementById('itemImpressao').value = 'Lisa';
      document.getElementById('itemMetroRolo').value = '';
      document.getElementById('itemValorUnitario').value = '';
    }

    // mostra/esconde Detalhes conforme impressão
    document.getElementById('itemImpressao').addEventListener('change', function(e) {
      const grp = document.getElementById('detalhesGroup');
      grp.style.display = (e.target.value === 'Pers.') ? 'block' : 'none';
    });

    function addItem() {
      const quantidade = parseFloat(document.getElementById('itemQtd').value);
      const unidade   = document.getElementById('itemUnidade').value;
      const produto   = document.getElementById('itemProduto').value;
      const medida    = document.getElementById('itemMedidaAdesivo').value;
      const impressao = document.getElementById('itemImpressao').value;
      const detalhes  = document.getElementById('itemDetalhes').value.trim();
      const metro     = document.getElementById('itemMetroRolo').value;
      const valor     = parseFloat(document.getElementById('itemValorUnitario').value);

      if (!quantidade || !produto || !valor) {
        alert('Preencha quantidade, produto e valor unitário.');
        return;
      }

      items.push({ quantidade, unidade, produto, medidaAdesivo: medida,
                   impressao, detalhes, metroRolo: metro, valorUnitario: valor });
      updateItemsTable();
      closeItemModal();
    }

    function updateItemsTable() {
      const body = document.getElementById('itemsTableBody');
      body.innerHTML = '';
      if (!items.length) {
        body.innerHTML = `
          <tr class="empty-state">
            <td colspan="7">
              <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM10 6a2 2 0 0 1 4 0v1h-4V6zm8 13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V9h2v1a1 1 0 0 0 2 0V9h2v10z"/></svg>
              <p>Nenhum item adicionado</p><small>Clique em "Adicionar Item"</small>
            </td>
          </tr>`;
      } else {
        items.forEach((it, i) => {
          const row = body.insertRow();
          row.innerHTML = `
            <td>${it.quantidade} ${it.unidade}</td>
            <td>${it.produto}</td>
            <td>${it.medidaAdesivo}</td>
            <td>${it.impressao}</td>
            <td>${it.metroRolo}</td>
            <td>R$ ${it.valorUnitario.toFixed(2).replace('.',',')}</td>
            <td><button class="remove-item" onclick="removeItem(${i})">&times;</button></td>`;
          row.style.cursor = 'pointer';
          row.addEventListener('click', e => {
            if (!e.target.classList.contains('remove-item')) openItemSummaryModal(it);
          });
        });
      }
      updateTotal();
    }

    function updateTotal() {
      const sumEl = document.getElementById('orderSummary');
      if (!items.length) return sumEl.innerHTML = '<p>Nenhum item adicionado</p>';
      let html = '<div style="font-size:14px;line-height:1.6">';
      let cxBob=0, cxEtq=0, cxRot=0, cxRib=0;
      items.forEach((it, i) => {
        if ((it.unidade==='CX'||it.unidade==='CXS')) {
          const p = it.produto.toLowerCase();
          if (p.includes('bob.')) cxBob+=it.quantidade;
          else if (p.includes('etq')) cxEtq+=it.quantidade;
          else if (p.includes('rotulo')||p.includes('rótulo')) cxRot+=it.quantidade;
          else if (p.includes('ribbon')) cxRib+=it.quantidade;
        }
        html += `<div style="margin-bottom:8px;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;">
          <strong>Item ${i+1}:</strong> ${it.quantidade} ${it.unidade} de ${it.produto}
          (${it.medidaAdesivo}) - ${it.impressao}
          ${it.detalhes?`- Detalhes: ${it.detalhes}`:''}
          - ${it.metroRolo} - R$ ${it.valorUnitario.toFixed(2).replace('.',',')}
        </div>`;
      });
      html += `<div style="margin-top:15px;padding:12px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);border-radius:4px;">
        <strong style="font-size:18px;">Quant. total em caixas:</strong><br>
        <span style="font-size:16px;">
          CX Bobinas: ${cxBob} | CX Etiquetas: ${cxEtq}
          | CX Rótulos: ${cxRot} | CX Ribbons: ${cxRib}
        </span>
      </div></div>`;
      sumEl.innerHTML = html;
    }

    function removeItem(idx) {
      if (confirm('Confirmar remoção deste item?')) {
        items.splice(idx,1);
        updateItemsTable();
      }
    }

    function openItemSummaryModal(item) {
      const modal = document.getElementById('itemSummaryModal');
      const c = document.getElementById('itemSummaryContent');
      c.innerHTML = `
        <div style="background:#f8fafc;padding:20px;border-radius:8px;">
          <p><strong>Quantidade:</strong> ${item.quantidade} ${item.unidade}</p>
          <p><strong>Produto:</strong> ${item.produto}</p>
          <p><strong>Medida:</strong> ${item.medidaAdesivo}</p>
          <p><strong>Impressão:</strong> ${item.impressao}</p>
          ${item.detalhes?`<p><strong>Detalhes:</strong> ${item.detalhes}</p>`:''}
          <p><strong>Metro do Rolo:</strong> ${item.metroRolo}</p>
          <p style="font-weight:bold;color:#003366;">
            <strong>Valor Unitário:</strong> R$ ${item.valorUnitario.toFixed(2).replace('.',',')}
          </p>
        </div>`;
      modal.style.display = 'block';
    }

    function closeItemSummaryModal() {
      document.getElementById('itemSummaryModal').style.display = 'none';
    }

    function confirmClearForm() {
      if (confirm('Limpar todo o formulário?')) clearForm();
    }

    function clearForm() {
      document.getElementById('pedidoForm').reset();
      items = [];
      updateItemsTable();
      document.getElementById('dataEmissao').value =
        new Date().toISOString().split('T')[0];
    }

    window.onclick = e => {
      if (e.target.id === 'itemModal') closeItemModal();
      if (e.target.id === 'itemSummaryModal') closeItemSummaryModal();
    };

    document.addEventListener('DOMContentLoaded', () => {
      updateItemsTable();
      document.getElementById('dataEmissao').value =
        new Date().toISOString().split('T')[0];
    });
  </script>

  <!-- RD Station Loader -->
  <script async src="https://d335luupugsy2.cloudfront.net/js/loader-scripts/552fc004-6b96-4465-944a-c4f5c4132f83-loader.js"></script>
</body>
</html>
